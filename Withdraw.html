<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UniPay - Withdraw</title>

<!-- Google Fonts & Font Awesome -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
    body {
        margin: 0;
        font-family: 'Poppins', sans-serif;
        background: #f5f6fa;
        overflow-x: hidden;
    }

    /* --- Top Bar --- */
    .topbar {
        width: 100%;
        padding: 15px 25px;
        background: linear-gradient(135deg,#4322ff,#944bff);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: fixed;
        top: 0;
        z-index: 100;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        box-sizing: border-box;
    }
    .back-btn { font-size: 22px; cursor: pointer; color: white; text-decoration: none; transition: 0.3s; }
    .back-btn:hover { transform: translateX(-5px); }
    .title { font-size: 20px; font-weight: 600; letter-spacing: 1px; }
    .spacer { width: 24px; }

    /* --- Main Content --- */
    .main-content {
        padding-top: 80px;
        padding-bottom: 40px;
        max-width: 600px;
        margin: 0 auto;
        padding-left: 20px;
        padding-right: 20px;
    }

    /* Method Selection Grid */
    .section-title { font-size: 16px; color: #555; margin-bottom: 15px; font-weight: 600; }
    
    .methods-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 25px;
    }

    .method-card {
        background: white;
        padding: 15px;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        border: 2px solid transparent;
        transition: 0.3s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .method-card:hover { transform: translateY(-3px); }
    .method-card.selected {
        border-color: #4322ff;
        background: #f0eeff;
    }
    .method-card i {
        font-size: 24px;
        color: #4322ff;
        margin-bottom: 8px;
        display: block;
    }
    .method-name { font-size: 14px; font-weight: 500; color: #333; }

    /* Input Form */
    .withdraw-form {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        display: none; /* Hidden until method selected */
        animation: slideDown 0.4s ease;
    }
    
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-size: 13px; color: #666; margin-bottom: 8px; }
    .input-group input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 16px;
        box-sizing: border-box;
        outline: none;
    }
    .input-group input:focus { border-color: #4322ff; }

    .btn-submit {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg,#4322ff,#944bff);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
    }
    .btn-submit:active { transform: scale(0.98); }

    /* History Section */
    .history-list { margin-top: 30px; }
    .history-item {
        background: white;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.03);
        animation: fadeIn 0.5s ease;
    }
    .h-left h4 { margin: 0; font-size: 15px; color: #333; }
    .h-left span { font-size: 12px; color: #888; }
    .h-right { text-align: right; }
    .h-amount { font-weight: 700; color: #4322ff; display: block; }
    .status-badge { 
        font-size: 10px; padding: 3px 8px; border-radius: 20px; 
        background: #fff3cd; color: #856404; font-weight: 600;
    }
    .btn-cancel {
        background: #ff4757;
        color: white;
        border: none;
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 12px;
        margin-top: 5px;
        cursor: pointer;
    }

    /* Popup Modal */
    .popup-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex; justify-content: center; align-items: center;
        z-index: 200;
        visibility: hidden; opacity: 0;
        transition: 0.3s;
    }
    .popup-content {
        background: white;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        width: 80%;
        max-width: 300px;
        transform: scale(0.8);
        transition: 0.3s;
    }
    .popup-overlay.active { visibility: visible; opacity: 1; }
    .popup-overlay.active .popup-content { transform: scale(1); }
    .popup-icon { font-size: 50px; color: #f1c40f; margin-bottom: 15px; }

    @keyframes slideDown { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
</style>
</head>
<body>

<!-- Top Bar -->
<div class="topbar">
    <a href="Dashboard.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i></a>
    <div class="title">Withdraw Money</div>
    <div class="spacer"></div>
</div>

<div class="main-content">

    <div class="section-title">Select Method</div>
    
    <div class="methods-grid">
        <div class="method-card" onclick="selectMethod('Bkash', 'number')">
            <i class="fa-solid fa-b"></i>
            <div class="method-name">Bkash</div>
        </div>
        <div class="method-card" onclick="selectMethod('Nagad', 'number')">
            <i class="fa-solid fa-n"></i>
            <div class="method-name">Nagad</div>
        </div>
        <div class="method-card" onclick="selectMethod('Binance Pay', 'email')">
            <i class="fa-brands fa-bitcoin"></i>
            <div class="method-name">Binance Pay</div>
        </div>
        <div class="method-card" onclick="selectMethod('UniPay Send', 'uid')">
            <i class="fa-solid fa-paper-plane"></i>
            <div class="method-name">UniPay Send</div>
        </div>
    </div>

    <!-- Input Form -->
    <div id="withdrawForm" class="withdraw-form">
        <div class="input-group">
            <label>Amount ($)</label>
            <input type="number" id="amount" placeholder="Min $10">
        </div>
        
        <div class="input-group">
            <label id="targetLabel">Account Number</label>
            <input type="text" id="targetAccount" placeholder="Enter details...">
        </div>

        <button class="btn-submit" onclick="submitWithdraw()">Confirm Withdraw</button>
    </div>

    <!-- History -->
    <div class="section-title" style="margin-top:30px;">Pending Requests</div>
    <div id="historyList" class="history-list">
        <div style="text-align:center; color:#999; font-size:13px;">Loading...</div>
    </div>

</div>

<!-- Pending Popup -->
<div id="popup" class="popup-overlay">
    <div class="popup-content">
        <div class="popup-icon"><i class="fa-solid fa-clock"></i></div>
        <h3>Request Pending</h3>
        <p style="color:#666; font-size:14px; margin:10px 0;">Please wait while we process your withdrawal.</p>
        <button class="btn-submit" onclick="closePopup()">Okay</button>
    </div>
</div>

<!-- Firebase Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getDatabase, ref, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2jgca0-hYv-Kzm0EKo9AaMwU3BCZcjdc",
        authDomain: "unipay-b0d26.firebaseapp.com",
        databaseURL: "https://unipay-b0d26-default-rtdb.firebaseio.com",
        projectId: "unipay-b0d26",
        storageBucket: "unipay-b0d26.firebasestorage.app",
        messagingSenderId: "289798099942",
        appId: "1:289798099942:web:50f3a077e12cb458b87c27",
        measurementId: "G-E3C7R73ZET"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser;
    let currentMethod = "";
    let currentBalance = 0; // Store user balance

    onAuthStateChanged(auth, user => {
        if(user){
            currentUser = user;
            loadUserData(); // Load balance
            loadHistory();  // Load history
        } else {
            // Redirect if not logged in
            window.location.href = "dashboard.html";
        }
    });

    // 1. Fetch User Balance
    function loadUserData() {
        onValue(ref(db, "users/" + currentUser.uid + "/balanceUSD"), (snapshot) => {
            currentBalance = snapshot.val() || 0;
            console.log("Current Balance:", currentBalance);
        });
    }

    // UI: Method Selection
    window.selectMethod = function(methodName, inputType) {
        currentMethod = methodName;
        
        // Highlight logic
        const cards = document.querySelectorAll('.method-card');
        cards.forEach(card => card.classList.remove('selected'));
        event.currentTarget.classList.add('selected');

        // Show Form
        const form = document.getElementById('withdrawForm');
        form.style.display = "block";

        // Update Label
        const label = document.getElementById('targetLabel');
        const input = document.getElementById('targetAccount');
        
        if(inputType === 'number') {
            label.innerText = "Wallet Number";
            input.placeholder = "017xxxxxxxx";
            input.type = "tel";
        } else if(inputType === 'email') {
            label.innerText = "Binance Pay ID / Email";
            input.placeholder = "Enter ID or Email";
            input.type = "text";
        } else {
            label.innerText = "Receiver User ID";
            input.placeholder = "UID...";
            input.type = "text";
        }
    }

    // 2. Submit Logic with Restriction
    window.submitWithdraw = function() {
        // --- NEW RESTRICTION ---
        if(currentBalance < 8) {
            alert("Deposit $3 to claim $5 bonus and activate the card.");
            return; // Stop function here
        }
        // -----------------------

        const amount = document.getElementById('amount').value;
        const account = document.getElementById('targetAccount').value;

        if(!amount || !account) return alert("Please fill all fields");
        if(amount < 10) return alert("Minimum withdrawal is $10");

        const withdrawData = {
            method: currentMethod,
            amount: amount,
            target: account,
            status: 'Pending',
            date: new Date().toLocaleString()
        };

        push(ref(db, "users/" + currentUser.uid + "/withdrawals"), withdrawData)
        .then(() => {
            document.getElementById('popup').classList.add('active');
            // Clear inputs
            document.getElementById('amount').value = "";
            document.getElementById('targetAccount').value = "";
        })
        .catch(err => alert("Error: " + err.message));
    }

    // History Logic
    function loadHistory() {
        const historyList = document.getElementById('historyList');
        
        onValue(ref(db, "users/" + currentUser.uid + "/withdrawals"), (snapshot) => {
            historyList.innerHTML = ""; // Clear list
            const data = snapshot.val();
            
            if(!data) {
                historyList.innerHTML = "<div style='text-align:center; color:#999; font-size:13px; margin-top:10px;'>No pending withdrawals</div>";
                return;
            }

            Object.entries(data).reverse().forEach(([key, item]) => {
                const html = `
                <div class="history-item">
                    <div class="h-left">
                        <h4>${item.method}</h4>
                        <span>${item.target}</span> <br>
                        <span class="status-badge">${item.status}</span>
                    </div>
                    <div class="h-right">
                        <span class="h-amount">-$${item.amount}</span>
                        <button class="btn-cancel" onclick="cancelRequest('${key}')">Cancel</button>
                    </div>
                </div>`;
                historyList.innerHTML += html;
            });
        });
    }

    window.cancelRequest = function(id) {
        if(confirm("Are you sure you want to cancel this withdrawal?")) {
            remove(ref(db, "users/" + currentUser.uid + "/withdrawals/" + id));
        }
    }

    window.closePopup = function() {
        document.getElementById('popup').classList.remove('active');
    }

</script>

</body>
</html>
